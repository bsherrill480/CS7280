<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Point on a map D3</title>

	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
	<script src="http://d3js.org/topojson.v1.min.js"></script>

	<style type="text/css">
		.background {
			fill: #eee;
			pointer-events: all;
		}
		.map-layer {
			fill: #fff;
			stroke: #aaa;
		}

		.effect-layer{
			pointer-events:none;
		}
		h1 {
			font-family: sans-serif;
		}

		text{
			font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
			font-weight: 300;
		}

		text.big-text{
			font-size: 20px;
			font-weight: 400;
		}

	</style>
	<meta http-equiv="cache-control" content="max-age=0" />
	<meta http-equiv="cache-control" content="no-cache" />
	<meta http-equiv="expires" content="0" />
	<meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
	<meta http-equiv="pragma" content="no-cache" />
</head>
<body>
<svg></svg>
<div>
	<div>
		Filter crime types:
	</div>
	<div>
		<div id="crime-types-ui">
		</div>
	</div>
</div>


<script type="text/javascript">
	var CRIME_TYPE_GROUPS = ['', 'PROWLER', 'PERSON DOWN/INJURY', 'HAZARDS', 'HARBOR CALLS',
		'PROSTITUTION', 'ROBBERY', 'ACCIDENT INVESTIGATION', 'BURGLARY', 'NULL', 'MENTAL HEALTH',
		'BEHAVIORAL HEALTH', 'AUTO THEFTS', 'PERSONS - LOST, FOUND, MISSING',
		'MOTOR VEHICLE COLLISION INVESTIGATION', 'PROPERTY DAMAGE', 'ANIMAL COMPLAINTS',
		'FALSE ALARMS', 'FALSE ALACAD', 'THREATS, HARASSMENT', 'ASSAULTS', 'DISTURBANCES',
		'OTHER PROPERTY', 'TRESPASS', 'FRAUD CALLS', 'NUISANCE, MISCHIEF', 'WEAPONS CALLS',
		'OTHER VICE', 'NARCOTICS COMPLAINTS', 'DRIVE BY (NO INJURY)', 'PROPERTY - MISSING, FOUND',
		'TRAFFIC RELATED CALLS', 'NUISANCE, MISCHIEF ', 'LEWD CONDUCT', 'SHOPLIFTING', 'CAR PROWL',
		'BIKE', 'MISCELLANEOUS MISDEMEANORS', 'PUBLIC GATHERINGS', 'FAILURE TO REGISTER (SEX OFFENDER)',
		'ARREST', 'SUSPICIOUS CIRCUMSTANCES', 'LIQUOR VIOLATIONS'];

	var crime_type_group_is_checked = {};

//	CRIME_TYPE_GROUPS.forEach(function (d) {
//		crime_type_group_is_checked[d] = true;
//	});


	// https://bl.ocks.org/john-guerra/43c7656821069d00dcbc
	var width = 960,
			height = 860,
			centered;

	// Define color scale
	var color = d3.scale.linear()
			.range(['#E0FFE6', '#006B2A']);

	var projection = d3.geo.mercator()
			.scale(100000)
			// Center the Map in Seattle
			.center([-122.3, 47.64])
			.translate([width / 2, height / 2]);

	var path = d3.geo.path()
			.projection(projection);

	// Set svg width & height
	var svg = d3.select('svg')
			.attr('width', width)
			.attr('height', height);

 	// Add background
	svg.append('rect')
			.attr('class', 'background')
			.attr('width', width)
			.attr('height', height)
//			.on('click', clicked);

	var g = svg.append('g');

	var effectLayer = g.append('g')
			.classed('effect-layer', true);

	var mapLayer = g.append('g')
			.classed('map-layer', true);

	var dotLayer = g.append('g')
			.classed('dot-layer', true);

	var dummyText = g.append('text')
			.classed('dummy-text', true)
			.attr('x', 10)
			.attr('y', 30)
			.style('opacity', 0);
	var scaleLayer = g.append('g')
			.classed('scaleLayer', true);
	var scaleLayerGradient = scaleLayer
			.append('defs')
			.append('linearGradient')
			.attr('id', 'linear-gradient')
			.attr('x1', '0%')
			.attr('y1', '0%')
			.attr('x2', '100%')
			.attr('y2', '0%');
	var minScaleText = scaleLayer
			.append('text')
			.attr('x', 0)
			.attr('y', height-30);
	var maxScaleText = scaleLayer
			.append('text')
			.attr('x', 140)
			.attr('y', height-30);
	var bigText = g.append('text')
			.classed('big-text', true)
			.attr('x', 20)
			.attr('y', 45);

	function getFnMinZhviOrMax(max) {
		return function (d) {
			var zhvi = d && d.properties && d.properties.zhvi ? d.properties.zhvi : max;
			return zhvi === -1 ? max : zhvi;
		}
	}


	function crimeTypeToClass(crimeType) {
		return crimeType.replace(/[^a-zA-Z]/g, '')
	}

	function processDots(data) {
		return data.map(function (item) {
			return {
				crimeType: item['Event Clearance Group'],
				loc: [item['Longitude'], item['Latitude']],
		};
		})
	}

	var renderPoliceDots = null;

	function renderFilterPoliceDotsUI() {
		var rootEl = document.getElementById('crime-types-ui');

		CRIME_TYPE_GROUPS.forEach(function (crime_type) {
			var option = document.createElement('input');
			var label = document.createElement('label');
			var container = document.createElement('div');
			container.appendChild(label);
			container.appendChild(option);
			label.innerText = crime_type;
			option.setAttribute('type', 'checkbox');
			option.checked = true;
			option.addEventListener('click', function () {
				console.log('clicked!', crime_type, option.checked);
				var className = crimeTypeToClass(crime_type);
				var isChecked = option.checked;
				var dotsToManipulate = document.getElementsByClassName(className);
				console.log('dotsTo', dotsToManipulate)
				var el;
				for(var i = 0; i < dotsToManipulate.length; i++) {
					el = dotsToManipulate[i];
					if (isChecked) {
						el.style.display = 'block'
					} else {
						el.style.display = 'none';
					}

				}

			});
			rootEl.appendChild(container);
		});
	}

	renderFilterPoliceDotsUI()

	d3.csv('short_incident.csv', function (error, data) {
		var dots = processDots(data);

		renderPoliceDots = function () {
			dotLayer.selectAll('circle')
					.data(dots)
					.enter()
					.append('circle')
					.attr('class', function (d) {
						return 'dot ' + crimeTypeToClass(d.crimeType);
					})
					.attr('cx', function (d) {
						var loc = d.loc;
						return projection(loc)[0];
					})
					.attr('cy', function (d) {
						var loc = d.loc;
						return projection(loc)[1];
					})
					.attr('r', '1px')
					.attr('fill', 'blue')
		};

		renderPoliceDots();
	});

	d3.json("Zillow_Zhvi_Neighborhoods_WA_Geo.json", function(error, mapData) {
		var features = mapData.features;
		var max_zvhi = d3.max(features, getZvhiOr0);
		var min_zvhi = d3.min(features, getFnMinZhviOrMax(max_zvhi));
		color.domain([min_zvhi, max_zvhi]);
		scaleLayerGradient
				.append('stop')
				.attr('stop-color', color(min_zvhi))
				.attr('offset', '0%');
		scaleLayerGradient
				.append('stop')
				.attr('stop-color', color(max_zvhi))
				.attr('offset', '100%');

		scaleLayer
				.append('rect')
				.attr('x', 10)
				.attr('y', height - 20)
				.attr('rx', 10)
				.attr('ry', 10)
				.attr('width', 200)
				.attr('height', 20)
				.attr('fill', 'url(#linear-gradient)');
		minScaleText.text('$' + min_zvhi.toLocaleString());
		maxScaleText.text('$' + max_zvhi.toLocaleString());


		// Draw each province as a path
		mapLayer.selectAll('path')
				.data(features)
				.enter().append('path')
				.attr('d', path)
				.attr('vector-effect', 'non-scaling-stroke')
				.style('fill', fillFn)
				.on('mouseover', mouseover)
				.on('mouseout', mouseout)
//				.on('click', clicked);

	});

	// Get province name
	function nameFn(d){
		return d && d.properties ? d.properties.name : null;
	}

	function zhviFn(d) {
		return d && d.properties ? d.properties.name : null;
	}

// Get province name length
//	function nameLength(d){
//		var n = nameFn(d);
//		return n ? n.length : 0;
//	}
	function getZvhiOr0(d){
		return d && d.properties ? d.properties.zhvi : 0;
	}

// Get color
	function fillFn(d){
		var zhvi = d.properties.zhvi;
		if (!zhvi) {
			console.log('bad zhvi', zhvi)
		} else if (zhvi === -1) {
			return '#000000';
		}
		return color(zhvi);
	}


	function addDescription(d) {
		var zhvi = d.zhvi;
		var cost = zhvi !== -1 ? '$' + zhvi.toLocaleString() : 'Not available';
		bigText.text(d.Name + ': ' + cost);
	}

	function mouseover(d){
		// Highlight hovered province
		d3.select(this).style('fill', 'orange');

		// Draw effects
		addDescription(d.properties);
//		textArt(nameFn(d));
	}

	function mouseout(d){
		// Reset province color
		mapLayer.selectAll('path')
				.style('fill', function(d){return centered && d===centered ? '#D5708B' : fillFn(d);});

		// Remove effect text
		effectLayer.selectAll('text').transition()
				.style('opacity', 0)
				.remove();
		bigText.text('')
	}

// http://bl.ocks.org/phil-pedruco/7745589
//var width = 950,
//    height = 550;
//
// set projection
//var projection = d3.geo.mercator();
//
// create path variable
//var path = d3.geo.path()
//    .projection(projection);
//
//d3.json("us.json", function(error, topo) {

//	console.log(topo);
//
//  	var states = topojson.feature(topo, topo.objects.states).features;
//
//  	// set projection parameters
//  	projection
//      .scale(2000)
//      .center([-108, 37.5]);
//
//    // create svg variable
//    var svg = d3.select("body").append("svg")
//    				.attr("width", width)
//    				.attr("height", height);
//
//    // points
//    var aa = [-122.490402, 37.786453];
//	var bb = [-122.389809, 37.72728];
//
//	console.log(projection(aa),projection(bb));
//
//	// add states from topojson
//	svg.selectAll("path")
//      .data(states).enter()
//      .append("path")
//      .attr("class", "feature")
//      .style("fill", "steelblue")
//      .attr("d", path);
//
//    // put boarder around states
//  	svg.append("path")
//      .datum(topojson.mesh(topo, topo.objects.states, function(a, b) { return a !== b; }))
//      .attr("class", "mesh")
//      .attr("d", path);
//
//    // add circles to svg
//    svg.selectAll("circle")
//		.data([aa,bb]).enter()
//		.append("circle")
//		.attr("cx", function (d) { console.log(projection(d)); return projection(d)[0]; })
//		.attr("cy", function (d) { return projection(d)[1]; })
//		.attr("r", "8px")
//		.attr("fill", "red")
//
//});

</script>

</body>
</html>